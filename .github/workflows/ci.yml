name: CI

on:
    push:
        branches:
            - '**'
    pull_request:
        branches:
            - '**'
    workflow_dispatch:

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        env:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        steps:
            - name: Checkout
              uses: actions/checkout@v2
              with:
                  fetch-depth: 0

            - name: Setup Node
              uses: actions/setup-node@v1
              with:
                  node-version: 14.x

            - name: Install GitVersion
              uses: gittools/actions/gitversion/setup@v0.9.7
              with:
                  versionSpec: 5.x

            - name: Determine Version
              uses: gittools/actions/gitversion/execute@v0.9.7
              with:
                  useConfigFile: true

            - name: Set Environment Variables
              run: |
                  echo "VERSION=$(echo ${{ env.GITVERSION_SEMVER }})" >> $GITHUB_ENV
                  echo "STAGE=$(echo ${{ env.GITVERSION_ESCAPEDBRANCHNAME }})" >> $GITHUB_ENV

            - name: Build
              env:
                  EXTEND_ESLINT: true
              run: |
                  yarn
                  yarn lint
                  yarn version --new-version ${{ env.VERSION }} --no-git-tag-version
                  yarn serverless:build --stage ${{ env.STAGE }} --region ${{ secrets.AWS_REGION }}

            - name: Deploy
              env:
                DB_HOST: ${{ secrets.DB_HOST }}
                DB_PORT: ${{ secrets.DB_PORT }}
                DB_USER: ${{ secrets.DB_USER }}
                DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
                DB_DATABASE: ${{ secrets.DB_DATABASE }}
                DB_SSL: ${{ secrets.DB_SSL }}
                JWT_SECURITY_KEY: ${{ secrets.JWT_SECURITY_KEY }}
                JWT_AUDIENCE: ${{ secrets.JWT_AUDIENCE }}
                JWT_ISSUER: ${{ secrets.JWT_ISSUER }}
                JWT_EXPIRES_IN: ${{ secrets.JWT_EXPIRES_IN }}
                EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}
                EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
                EMAIL_SMTP_USERNAME: ${{ secrets.EMAIL_SMTP_USERNAME }}
                EMAIL_SMTP_PASSWORD: ${{ secrets.EMAIL_SMTP_PASSWORD }}
                EMAIL_NO_REPLY_ADDRESS:  ${{ secrets.EMAIL_NO_REPLY_ADDRESS }}
                SEED_EMAIL_ADDRESS: ${{secrets.SEED_EMAIL_ADDRESS }}
                SEED_PASSWORD: ${{ secrets.SEED_PASSWORD }}
              run: |
                  yarn serverless:deploy --stage ${{ env.STAGE }} --region ${{ secrets.AWS_REGION }}
                  yarn db:seed
